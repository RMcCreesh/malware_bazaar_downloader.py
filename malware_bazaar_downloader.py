import os
import requests

TAG = input("Enter the Malware Bazaar tag: ")
DOWNLOAD_LIMIT = int(input("Enter the download limit: ")) #Limited to a maximum of 2,000 per day

# Query the API for tag information
api_url = "https://mb-api.abuse.ch/api/v1/"
payload = {"query": "get_taginfo", "tag": TAG, "limit": DOWNLOAD_LIMIT}
response = requests.post(api_url, data=payload)
data = response.json()["data"]

# Create a folder for the tag
tag_folder = TAG
os.makedirs(tag_folder, exist_ok=True)

# Download the samples using their SHA256 hashes
for i, entry in enumerate(data, start=1):
    sha256_hash = entry["sha256_hash"]
    print(f"Downloading sample {i}/{DOWNLOAD_LIMIT}: {sha256_hash}")
    
    # Query the API to get the file content
    file_payload = {"query": "get_file", "sha256_hash": sha256_hash}
    file_response = requests.post(api_url, data=file_payload)
    file_content = file_response.content
    
    # Save the content to a file in the tag folder
    with open(os.path.join(tag_folder, f"{sha256_hash}.sample"), "wb") as f:
        f.write(file_content)

# Save the SHA256 hashes to a file
hashes = [entry["sha256_hash"] for entry in data]
with open(os.path.join(tag_folder, f"{TAG}.hash"), "w") as f:
    f.write("\n".join(hashes))

print("Download completed.")
